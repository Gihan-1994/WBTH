# .editorconfig

```
root = true

[*]
indent_style = space
indent_size = 2
charset = utf-8
end_of_line = lf
insert_final_newline = true
trim_trailing_whitespace = true

```

# .envrc.example

```example

```

# .eslintrc.cjs

```cjs

```

# .github/ISSUE_TEMPLATE/bug_report.md

```md

```

# .github/ISSUE_TEMPLATE/feature_request.md

```md

```

# .github/PULL_REQUEST_TEMPLATE.md

```md

```

# .github/workflows/ci.yml

```yml

```

# .github/workflows/release.yml

```yml

```

# .gitignore

```
node_modules
.env
*.local
dist
.next
coverage
.mypy_cache
__pycache__/
*.pyc
.DS_Store

```

# .idea/.gitignore

```
# Default ignored files
/shelf/
/workspace.xml
# Editor-based HTTP Client requests
/httpRequests/
# Datasource local storage ignored files
/dataSources/
/dataSources.local.xml

```

# .idea/jsLibraryMappings.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="JavaScriptLibraryMappings">
    <includedPredefinedLibrary name="Node.js Core" />
    <excludedPredefinedLibrary name="HTML" />
  </component>
</project>
```

# .idea/MarsCodeWorkspaceAppSettings.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="com.codeverse.userSettings.MarscodeWorkspaceAppSettingsState">
    <option name="chatAppRouterInfo" value="builder/6918fd72d3cf009ebf5ad442" />
    <option name="progress" value="1.0" />
  </component>
</project>
```

# .idea/material_theme_project_new.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="MaterialThemeProjectNewConfig">
    <option name="metadata">
      <MTProjectMetadataState>
        <option name="migrated" value="true" />
        <option name="pristineConfig" value="false" />
        <option name="userId" value="-95ae951:1996dd00028:-7ffe" />
      </MTProjectMetadataState>
    </option>
  </component>
</project>
```

# .idea/misc.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="Black">
    <option name="sdkName" value="WBTH" />
  </component>
</project>
```

# .idea/modules.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="ProjectModuleManager">
    <modules>
      <module fileurl="file://$PROJECT_DIR$/.idea/WBTH.iml" filepath="$PROJECT_DIR$/.idea/WBTH.iml" />
    </modules>
  </component>
</project>
```

# .idea/WBTH.iml

```iml
<?xml version="1.0" encoding="UTF-8"?>
<module type="WEB_MODULE" version="4">
  <component name="FacetManager">
    <facet type="Python" name="Python facet">
      <configuration sdkName="WBTH" />
    </facet>
  </component>
  <component name="NewModuleRootManager">
    <content url="file://$MODULE_DIR$">
      <excludeFolder url="file://$MODULE_DIR$/.tmp" />
      <excludeFolder url="file://$MODULE_DIR$/temp" />
      <excludeFolder url="file://$MODULE_DIR$/tmp" />
    </content>
    <orderEntry type="inheritedJdk" />
    <orderEntry type="sourceFolder" forTests="false" />
    <orderEntry type="library" name="WBTH interpreter library" level="application" />
  </component>
</module>
```

# .idea/workspace.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="AutoImportSettings">
    <option name="autoReloadType" value="SELECTIVE" />
  </component>
  <component name="ChangeListManager">
    <list default="true" id="ab04c187-64dd-496b-a8e2-0a1b482fd14f" name="Changes" comment="" />
    <option name="SHOW_DIALOG" value="false" />
    <option name="HIGHLIGHT_CONFLICTS" value="true" />
    <option name="HIGHLIGHT_NON_ACTIVE_CHANGELIST" value="false" />
    <option name="LAST_RESOLUTION" value="IGNORE" />
  </component>
  <component name="ProjectColorInfo">{
  &quot;associatedIndex&quot;: 6
}</component>
  <component name="ProjectId" id="35X0r1uDjwfmtPtxIYLqk5ntQiQ" />
  <component name="ProjectViewState">
    <option name="hideEmptyMiddlePackages" value="true" />
    <option name="showLibraryContents" value="true" />
  </component>
  <component name="PropertiesComponent"><![CDATA[{
  "keyToString": {
    "Docker.db/docker-compose.postgres.yml.db: Compose Deployment.executor": "Run",
    "ModuleVcsDetector.initialDetectionPerformed": "true",
    "RunOnceActivity.ShowReadmeOnStart": "true",
    "RunOnceActivity.TerminalTabsStorage.copyFrom.TerminalArrangementManager.252": "true",
    "javascript.nodejs.core.library.configured.version": "24.8.0",
    "javascript.nodejs.core.library.typings.version": "24.8.1",
    "last_opened_file_path": "/home/gihan/Downloads/AI/roo-cline-3.30.3.vsix",
    "node.js.detected.package.eslint": "true",
    "node.js.detected.package.tslint": "true",
    "node.js.selected.package.eslint": "(autodetect)",
    "node.js.selected.package.tslint": "(autodetect)",
    "nodejs_package_manager_path": "npm",
    "npm.prisma > build.executor": "Run",
    "npm.prisma > migrate.executor": "Run",
    "npm.prisma > seed.executor": "Run",
    "settings.editor.selected.configurable": "preferences.pluginManager",
    "ts.external.directory.path": "/home/gihan/WBTH/node_modules/typescript/lib",
    "vue.rearranger.settings.migration": "true"
  }
}]]></component>
  <component name="RecentsManager">
    <key name="CopyFile.RECENT_KEYS">
      <recent name="$PROJECT_DIR$" />
    </key>
  </component>
  <component name="RunManager" selected="Docker.db/docker-compose.postgres.yml: Compose Deployment">
    <configuration default="true" type="docker-deploy" factoryName="docker-compose.yml" temporary="true">
      <deployment type="docker-compose.yml" />
      <method v="2" />
    </configuration>
    <configuration name="db/docker-compose.postgres.yml: Compose Deployment" type="docker-deploy" factoryName="docker-compose.yml" temporary="true" server-name="Docker">
      <deployment type="docker-compose.yml">
        <settings>
          <option name="sourceFilePath" value="infra/db/docker-compose.postgres.yml" />
        </settings>
      </deployment>
      <method v="2" />
    </configuration>
    <configuration name="db/docker-compose.postgres.yml.db: Compose Deployment" type="docker-deploy" factoryName="docker-compose.yml" temporary="true" server-name="Docker">
      <deployment type="docker-compose.yml">
        <settings>
          <option name="services">
            <list>
              <option value="db" />
            </list>
          </option>
          <option name="sourceFilePath" value="infra/db/docker-compose.postgres.yml" />
        </settings>
      </deployment>
      <method v="2" />
    </configuration>
    <configuration name="prisma &gt; build" type="js.build_tools.npm" temporary="true" nameIsGenerated="true">
      <package-json value="$PROJECT_DIR$/packages/prisma/package.json" />
      <command value="run" />
      <scripts>
        <script value="build" />
      </scripts>
      <node-interpreter value="project" />
      <envs />
      <method v="2" />
    </configuration>
    <configuration name="prisma &gt; migrate" type="js.build_tools.npm" temporary="true" nameIsGenerated="true">
      <package-json value="$PROJECT_DIR$/packages/prisma/package.json" />
      <command value="run" />
      <scripts>
        <script value="migrate" />
      </scripts>
      <node-interpreter value="project" />
      <envs />
      <method v="2" />
    </configuration>
    <configuration name="prisma &gt; seed" type="js.build_tools.npm" temporary="true" nameIsGenerated="true">
      <package-json value="$PROJECT_DIR$/packages/prisma/package.json" />
      <command value="run" />
      <scripts>
        <script value="seed" />
      </scripts>
      <node-interpreter value="project" />
      <envs />
      <method v="2" />
    </configuration>
    <recent_temporary>
      <list>
        <item itemvalue="Docker.db/docker-compose.postgres.yml: Compose Deployment" />
        <item itemvalue="Docker.db/docker-compose.postgres.yml.db: Compose Deployment" />
        <item itemvalue="npm.prisma &gt; seed" />
        <item itemvalue="npm.prisma &gt; migrate" />
        <item itemvalue="npm.prisma &gt; build" />
      </list>
    </recent_temporary>
  </component>
  <component name="SharedIndexes">
    <attachedChunks>
      <set>
        <option value="bundled-js-predefined-d6986cc7102b-3aa1da707db6-JavaScript-WS-252.27397.92" />
      </set>
    </attachedChunks>
  </component>
  <component name="TaskManager">
    <task active="true" id="Default" summary="Default task">
      <changelist id="ab04c187-64dd-496b-a8e2-0a1b482fd14f" name="Changes" comment="" />
      <created>1763241307588</created>
      <option name="number" value="Default" />
      <option name="presentableId" value="Default" />
      <updated>1763241307588</updated>
      <workItem from="1763241316558" duration="4677000" />
      <workItem from="1763246069555" duration="5178000" />
      <workItem from="1763251327701" duration="1791000" />
      <workItem from="1763253355263" duration="434000" />
      <workItem from="1763253840097" duration="755000" />
      <workItem from="1763254649718" duration="3992000" />
    </task>
    <servers />
  </component>
  <component name="TypeScriptGeneratedFilesManager">
    <option name="version" value="3" />
  </component>
</project>
```

# .nvmrc

```

```

# .prettierignore

```

```

# .prettierrc

```

```

# apps/api/package.json

```json
{
  "name": "api",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "echo 'API service not yet implemented. See apps/web for v1 API routes.'",
    "build": "echo 'API service not yet implemented.'",
    "start": "echo 'API service not yet implemented.'"
  }
}

```

# apps/api/tsconfig.json

```json
{
  "extends": "@repo/typescript-config/base.json",
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["src/**/*.ts"],
  "exclude": ["node_modules"]
}

```

# apps/ml/api.py

```py
from flask import Flask, request, jsonify

app = Flask(__name__)

@app.route('/recommendations/accommodations', methods=['POST'])
def recommend_accommodations():
    data = request.get_json()
    # TODO: Implement accommodation recommendation logic based on spec
    # - Hard Rule Filters (availability, budget, amenities, location, group size)
    # - Scoring (weighted sum of interests, style, price, amenities, location, group, rating, popularity)
    # - Rule-Based Filtering (post-score pruning)
    print("Received accommodation recommendation request:", data)
    return jsonify({
        "message": "Accommodation recommendation endpoint (TODO)",
        "input": data,
        "recommendations": [] # Placeholder
    })

@app.route('/match/guides', methods=['POST'])
def match_guides():
    data = request.get_json()
    # TODO: Implement guide matching logic based on spec
    # - Hard Rule Filters (duration, language, location, gender)
    # - Scoring (point-additive for location, languages, specializations, duration, gender, popularity, rating)
    print("Received guide matching request:", data)
    return jsonify({
        "message": "Guide matching endpoint (TODO)",
        "input": data,
        "matches": [] # Placeholder
    })

@app.route('/health', methods=['GET'])
def health_check():
    return jsonify({"status": "ok"})

if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=5000)

```

# apps/ml/package.json

```json
{
  "name": "ml",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "python api.py",
    "start": "python api.py"
  }
}

```

# apps/ml/requirements.txt

```txt
Flask==2.3.3
scikit-learn==1.3.2

```

# apps/QWEN.md

```md
# WBTH Apps Directory Context

This file provides context for AI assistants working on applications within the WBTH monorepo.

## Directory Overview
- **Location**: `/apps/` - Contains individual applications in the monorepo
- **Structure**: Multi-app monorepo managed by Turbo (turbo.json)

## App Development Guidelines
- Each app may have its own package.json but shares root configuration
- Follow monorepo patterns for dependencies and shared code
- Use consistent TypeScript configuration from root tsconfig.json
- Maintain consistent linting and formatting across all apps

## Common App Patterns
- Likely React/Next.js applications (common monorepo pattern)
- May share components, utilities, or services from other directories
- Each app should be independently deployable
- Use shared configuration from the root directory

## Development Considerations
- Changes in one app may affect others if using shared dependencies
- Use `turbo` commands for building and running apps efficiently
- Check for shared packages/libraries that apps may depend on
- Follow the architecture as defined in wbth_6_week_build_plan_architecture_spec.md
```

# apps/web/app/globals.css

```css
@tailwind base;
@tailwind components;
@tailwind utilities;

```

# apps/web/app/layout.tsx

```tsx
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css";

const inter = Inter({ subsets: ["latin"] });

export const metadata: Metadata = {
  title: "WBTH - Web-Based Tourism Hub",
  description: "Your ultimate tourism hub",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <body className={inter.className}>{children}</body>
    </html>
  );
}

```

# apps/web/app/page.tsx

```tsx
export default function Home() {
  return (
    <main className="flex min-h-screen flex-col items-center justify-between p-24">
      <h1 className="text-4xl font-bold">Welcome to WBTH!</h1>
      <p className="text-lg">Your Web-Based Tourism Hub is coming soon.</p>
    </main>
  );
}

```

# apps/web/middleware.ts

```ts
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export function middleware(req: NextRequest) {
  const path = req.nextUrl.pathname;
  // very light RBAC gate (expand later)
  if (path.startsWith('/(dashboard)') && !req.cookies.get('session')) {
    return NextResponse.redirect(new URL('/(auth)/login', req.url));
  }
  return NextResponse.next();
}

```

# apps/web/next.config.js

```js
/** @type {import('next').NextConfig} */
const nextConfig = {
  transpilePackages: ["@repo/ui", "@repo/lib"], // Adjust based on your actual shared packages
};

module.exports = nextConfig;

```

# apps/web/package.json

```json
{
  "name": "web",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint"
  },
  "dependencies": {
    "next": "^14.0.4",
    "react": "^18",
    "react-dom": "^18"
  },
  "devDependencies": {
    "@types/node": "^20",
    "@types/react": "^18",
    "@types/react-dom": "^18",
    "autoprefixer": "^10.0.1",
    "eslint": "^8",
    "eslint-config-next": "14.0.4",
    "postcss": "^8",
    "tailwindcss": "^3.3.0",
    "typescript": "^5"
  }
}

```

# apps/web/postcss.config.js

```js
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
};

```

# apps/web/public/logo.svg

This is a file of the type: SVG Image

# apps/web/tailwind.config.ts

```ts
import type { Config } from "tailwindcss";

const config: Config = {
  content: [
    "./pages/**/*.{js,ts,jsx,tsx,mdx}",
    "./components/**/*.{js,ts,jsx,tsx,mdx}",
    "./app/**/*.{js,ts,jsx,tsx,mdx}",
    "../../packages/ui/**/*.{js,ts,jsx,tsx}", // Include shared UI package
  ],
  theme: {
    extend: {
      backgroundImage: {
        "gradient-radial": "radial-gradient(var(--tw-gradient-stops))",
        "gradient-conic":
          "conic-gradient(from 180deg at 50% 50%, var(--tw-gradient-stops))",
      },
    },
  },
  plugins: [],
};
export default config;

```

# apps/web/tsconfig.json

```json
{
  "extends": "@repo/typescript-config/nextjs.json",
  "compilerOptions": {
    "plugins": [
      {
        "name": "next"
      }
    ],
    "baseUrl": ".",
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": ["next-env.d.ts", "**/*.ts", "**/*.tsx", ".next/types/**/*.ts"],
  "exclude": ["node_modules"]
}

```

# docs/adr/0001-monorepo-structure.md

```md

```

# docs/adr/0002-db-choice-prisma-postgres.md

```md

```

# docs/adr/0003-auth-and-rbac.md

```md

```

# docs/api/contracts.md

```md

```

# docs/api/openapi.yaml

```yaml

```

# docs/README.md

```md

```

# docs/runbooks/deploy-ml-cloud-run.md

```md

```

# docs/runbooks/deploy-web-vercel.md

```md

```

# docs/runbooks/rollback.md

```md

```

# docs/runbooks/seeding.md

```md

```

# infra/db/backup.sh

```sh

```

# infra/db/docker-compose.postgres.yml

```yml
version: "3.9"
services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_PASSWORD: password
      POSTGRES_USER: user
      POSTGRES_DB: wbth
    ports: ["5432:5432"]
    volumes:
      - pgdata:/var/lib/postgresql/data
volumes:
  pgdata:

```

# infra/db/README.md

```md

```

# infra/db/restore.sh

```sh

```

# infra/gcp/cloudrun-service-ml.yaml

```yaml

```

# infra/gcp/README.md

```md

```

# infra/gcp/service-account-ml.json.example

```example

```

# infra/vercel/env.example

```example

```

# infra/vercel/vercel.json

```json
{
  "buildCommand": "yarn -C apps/web build",
  "outputDirectory": "apps/web/.next",
  "framework": "nextjs"
}

```

# package.json

```json
{
  "name": "wbth",
  "private": true,
  "scripts": {
    "dev": "turbo run dev --parallel",
    "build": "turbo run build",
    "lint": "turbo run lint",
    "test": "turbo run test",
    "typecheck": "turbo run typecheck",
    "migrate": "yarn -C packages/prisma prisma migrate deploy",
    "seed": "yarn -C packages/prisma prisma db seed"
  },
  "devDependencies": {
    "turbo": "^2.0.0",
    "prettier": "^3.3.3"
  },
  "workspaces": [
    "apps/*",
    "packages/*",
    "packages/config/*"
  ]
}

```

# packages/config/eslint-config/library.js

```js
const { resolve } = require("node:path");

const project = resolve(process.cwd(), "tsconfig.json");

/** @type {import("eslint").Linter.Config} */
module.exports = {
  extends: ["eslint:recommended", "prettier", "eslint-config-turbo"],
  globals: {
    React: true,
    JSX: true,
  },
  env: {
    node: true,
  },
  settings: {
    "import/resolver": {
      typescript: {
        project,
      },
    },
  },
  ignorePatterns: [
    // Ignore dotfiles
    ".*.js",
    "node_modules/",
    "dist/",
  ],
  overrides: [
    {
      files: ["*.js", "*.ts", "*.tsx"],
      rules: {
        "turbo/no-undeclared-env-vars": "off", // Adjust as needed
      },
    },
  ],
};

```

# packages/config/eslint-config/next.js

```js
const { resolve } = require("node:path");

const project = resolve(process.cwd(), "tsconfig.json");

/** @type {import("eslint").Linter.Config} */
module.exports = {
  extends: [
    require.resolve("./library.js"),
    "next/core-web-vitals",
    "prettier",
  ],
  globals: {
    React: true,
    JSX: true,
  },
  env: {
    node: true,
    browser: true,
  },
  settings: {
    "import/resolver": {
      typescript: {
        project,
      },
    },
  },
  ignorePatterns: [
    // Ignore dotfiles
    ".*.js",
    "node_modules/",
    "dist/",
    ".next/",
  ],
  overrides: [{ files: ["*.js", "*.ts", "*.tsx"], rules: {} }],
};

```

# packages/config/eslint-config/package.json

```json
{
  "name": "@repo/eslint-config",
  "version": "0.0.0",
  "private": true,
  "files": [
    "library.js",
    "next.js",
    "react-internal.js"
  ],
  "devDependencies": {
    "@next/eslint-plugin-next": "^14.0.4",
    "@types/eslint": "^8.56.1",
    "@types/node": "^20.10.6",
    "@typescript-eslint/eslint-plugin": "^6.16.0",
    "@typescript-eslint/parser": "^6.16.0",
    "eslint": "^8.56.0",
    "eslint-config-prettier": "^9.1.0",
    "eslint-config-turbo": "^1.11.3",
    "eslint-plugin-import": "^2.29.1",
    "eslint-plugin-jsx-a11y": "^6.8.0",
    "eslint-plugin-react": "^7.33.2",
    "eslint-plugin-react-hooks": "^4.6.0",
    "typescript": "^5.3.3"
  }
}

```

# packages/config/eslint-config/react-internal.js

```js
const { resolve } = require("node:path");

const project = resolve(process.cwd(), "tsconfig.json");

/** @type {import("eslint").Linter.Config} */
module.exports = {
  extends: [
    "eslint:recommended",
    "prettier",
    "eslint-config-turbo",
    "plugin:react/recommended",
    "plugin:react-hooks/recommended",
    "plugin:jsx-a11y/recommended",
  ],
  globals: {
    React: true,
    JSX: true,
  },
  env: {
    node: true,
    browser: true,
  },
  settings: {
    "import/resolver": {
      typescript: {
        project,
      },
    },
    react: {
      version: "detect",
    },
  },
  ignorePatterns: [
    // Ignore dotfiles
    ".*.js",
    "node_modules/",
    "dist/",
  ],
  overrides: [
    {
      files: ["*.js", "*.ts", "*.tsx"],
      rules: {
        "turbo/no-undeclared-env-vars": "off", // Adjust as needed
      },
    },
  ],
};

```

# packages/config/typescript-config/base.json

```json
{
  "$schema": "https://json.schemastore.org/tsconfig",
  "display": "Default",
  "compilerOptions": {
    "composite": true,
    "declaration": true,
    "declarationMap": true,
    "esModuleInterop": true,
    "forceConsistentCasingInFileNames": true,
    "inlineSources": false,
    "isolatedModules": true,
    "moduleResolution": "Bundler",
    "noUnusedLocals": false,
    "noUnusedParameters": false,
    "preserveWatchOutput": true,
    "skipLibCheck": true,
    "strict": true
  },
  "exclude": ["node_modules"]
}

```

# packages/config/typescript-config/nextjs.json

```json
{
  "$schema": "https://json.schemastore.org/tsconfig",
  "display": "Next.js",
  "extends": "./base.json",
  "compilerOptions": {
    "lib": ["es2022", "dom", "dom.iterable"],
    "plugins": [{ "name": "next" }],
    "allowJs": true,
    "jsx": "preserve",
    "noEmit": true,
    "resolveJsonModule": true,
    "target": "es5"
  }
}

```

# packages/config/typescript-config/package.json

```json
{
  "name": "@repo/typescript-config",
  "version": "0.0.0",
  "private": true,
  "files": [
    "base.json",
    "nextjs.json",
    "react-library.json"
  ]
}

```

# packages/config/typescript-config/react-library.json

```json
{
  "$schema": "https://json.schemastore.org/tsconfig",
  "display": "React Library",
  "extends": "./base.json",
  "compilerOptions": {
    "lib": ["es2022", "dom"],
    "jsx": "react-jsx"
  }
}

```

# packages/lib/package.json

```json
{
  "name": "@repo/lib",
  "version": "0.0.0",
  "private": true,
  "main": "./src/index.ts",
  "types": "./src/index.ts",
  "scripts": {
    "lint": "eslint .",
    "build": "tsc"
  },
  "devDependencies": {
    "@repo/eslint-config": "*",
    "@repo/typescript-config": "*",
    "typescript": "^5.3.3"
  }
}

```

# packages/lib/README.md

```md

```

# packages/lib/src/auth/rbac.ts

```ts

```

# packages/lib/src/auth/tokens.ts

```ts

```

# packages/lib/src/dto/accommodation.ts

```ts

```

# packages/lib/src/dto/booking.ts

```ts

```

# packages/lib/src/dto/event.ts

```ts

```

# packages/lib/src/dto/guide.ts

```ts

```

# packages/lib/src/dto/index.ts

```ts

```

# packages/lib/src/dto/notification.ts

```ts

```

# packages/lib/src/dto/payment.ts

```ts

```

# packages/lib/src/dto/rating.ts

```ts

```

# packages/lib/src/dto/user.ts

```ts

```

# packages/lib/src/index.ts

```ts
// This is the entry point for your shared TypeScript utilities.
// You can export functions, types, and constants from here.

export function greet(name: string): string {
  return `Hello, ${name}!`;
}

```

# packages/lib/src/utils/errors.ts

```ts

```

# packages/lib/src/utils/fetcher.ts

```ts

```

# packages/lib/src/utils/logger.ts

```ts

```

# packages/lib/src/utils/pagination.ts

```ts

```

# packages/lib/src/validation/booking.zod.ts

```ts

```

# packages/lib/src/validation/index.ts

```ts

```

# packages/lib/src/validation/user.zod.ts

```ts

```

# packages/lib/tsconfig.json

```json
{
  "extends": "@repo/typescript-config/base.json",
  "compilerOptions": {
    "outDir": "dist",
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["src/**/*.ts"],
  "exclude": ["node_modules"]
}

```

# packages/prisma/package.json

```json
{
  "name": "@repo/prisma",
  "version": "0.0.0",
  "private": true,
  "scripts": {
    "build": "prisma generate",
    "migrate": "prisma migrate deploy",
    "seed": "ts-node seed.ts"
  },
  "devDependencies": {
    "prisma": "^5.10.2",
    "typescript": "^5.3.3"
  },
  "dependencies": {
    "@prisma/client": "^5.10.2",
    "@types/node": "^24.10.1",
    "ts-node": "^10.9.2",
    "typescript": "^5.9.3"
  }
}




```

# packages/prisma/README.md

```md

```

# packages/prisma/schema.prisma

```prisma
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  tourist
  guide
  accommodation_provider
  admin
}

model User {
  id            String    @id @default(uuid())
  name          String
  email         String    @unique
  password_hash String
  contact_no    String?
  role          UserRole  @default(tourist)
  created_at    DateTime  @default(now()) @map("created_at")

  guide                Guide?
  accommodationProvider AccommodationProvider?
  bookings             Booking[]
  paymentsSent         Payment[]              @relation("SenderPayments")
  paymentsReceived     Payment[]              @relation("ReceiverPayments")
  notifications        Notification[]
  admin                Admin?

  @@map("users")
}

model Guide {
  user_id      String   @id
  user         User     @relation(fields: [user_id], references: [id])
  experience   String[]
  languages    String[]
  expertise    String[]
  rating       Float?
  account_no   String?
  price        Float?

  @@map("guides")
}

model AccommodationProvider {
  user_id      String @id
  user         User   @relation(fields: [user_id], references: [id])
  provider_id  String @unique @default(uuid())
  company_name String

  accommodations Accommodation[]

  @@map("accommodation_providers")
}

model Accommodation {
  id                String                 @id @default(uuid())
  provider_id       String
  provider          AccommodationProvider @relation(fields: [provider_id], references: [provider_id])
  name              String
  type              String[]
  amenities         String[]
  rating            Float?
  account_no        String?
  budget            String[] // Consider a more structured type if needed
  location          String // city + lat/lng or district
  price_range_min   Float?
  price_range_max   Float?
  province          String?
  interests         String[]
  group_size        Int?
  num_booking_dates Int?
  prior_bookings    Int?

  bookings Booking[]

  @@map("accommodations")
}

enum BookingType {
  accommodation
  guide
}

enum BookingStatus {
  pending
  confirmed
  cancelled
}

model Booking {
  id          String        @id @default(uuid())
  user_id     String
  user        User          @relation(fields: [user_id], references: [id])
  type        BookingType
  start_date  DateTime      @map("start_date")
  end_date    DateTime      @map("end_date")
  location    String?
  price       Float
  status      BookingStatus @default(pending)
  description String[]

  accommodation_id String?
  accommodation    Accommodation? @relation(fields: [accommodation_id], references: [id])

  payments Payment[]

  @@map("bookings")
}

model Rating {
  id          String  @id @default(uuid())
  provider_id String // This could be user_id of Guide or AccommodationProvider
  rating      Int     // Removed @min(1) @max(5) as these are not valid Prisma attributes.
                        // Validation should be handled at the application level.

  @@map("ratings")
}

model Event {
  id          String   @id @default(uuid())
  category    String
  date        DateTime
  location    String
  description String[]

  @@map("events")
}

model Payment {
  id          String   @id @default(uuid())
  receiver_id String
  receiver    User     @relation("ReceiverPayments", fields: [receiver_id], references: [id])
  sender_id   String
  sender      User     @relation("SenderPayments", fields: [sender_id], references: [id])
  booking_id  String
  booking     Booking  @relation(fields: [booking_id], references: [id])
  amount      Float
  status      String // e.g., "completed", "pending", "failed"

  @@map("payments")
}

model Notification {
  id         String   @id @default(uuid())
  user_id    String
  user       User     @relation(fields: [user_id], references: [id])
  type       String
  message    String[]
  created_at DateTime @default(now()) @map("created_at")

  @@map("notifications")
}

model Admin {
  id            String @id @default(uuid())
  user_id       String @unique
  user          User   @relation(fields: [user_id], references: [id])
  email         String @unique
  password_hash String

  @@map("admins")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

```

# packages/prisma/seed.ts

```ts
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function main() {
  console.log('Start seeding...');
  // Add your seed data here based on the spec
  // Example:
  // await prisma.user.create({
  //   data: {
  //     name: 'Admin User',
  //     email: 'admin@example.com',
  //     password_hash: 'hashed_password', // In a real app, hash this securely
  //     role: 'admin',
  //   },
  // });
  console.log('Seeding finished.');
}

main()
  .catch((e) => {
    console.error(e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });

```

# packages/prisma/seed/accommodations.ts

```ts

```

# packages/prisma/seed/events.ts

```ts

```

# packages/prisma/seed/guides.ts

```ts

```

# packages/prisma/seed/index.ts

```ts
import { prisma } from '../src/client';
import users from './users';
import guides from './guides';
import accommodations from './accommodations';
import events from './events';

async function main() {
  await prisma.user.createMany({ data: users });
  // …create related guides, accommodations, events
}
main().catch((e) => { console.error(e); process.exit(1); }).finally(async () => prisma.$disconnect());

```

# packages/prisma/seed/users.ts

```ts

```

# packages/prisma/src/client.ts

```ts
import { PrismaClient } from '@prisma/client';
export const prisma = new PrismaClient();

```

# packages/prisma/src/types.ts

```ts

```

# packages/prisma/tsconfig.json

```json
{
  "extends": "@repo/typescript-config/base.json",
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["**/*.ts"],
  "exclude": ["node_modules"]
}

```

# packages/ui/package.json

```json
{
  "name": "@repo/ui",
  "version": "0.0.0",
  "private": true,
  "main": "./src/index.tsx",
  "types": "./src/index.tsx",
  "scripts": {
    "lint": "eslint .",
    "generate:component": "turbo gen react-component"
  },
  "devDependencies": {
    "@repo/eslint-config": "*",
    "@repo/typescript-config": "*",
    "@types/node": "^20.10.6",
    "@types/react": "^18.2.46",
    "@types/react-dom": "^18.2.18",
    "eslint": "^8.56.0",
    "react": "^18.2.0",
    "typescript": "^5.3.3"
  },
  "dependencies": {
    "tailwindcss": "^3.4.1"
  }
}

```

# packages/ui/README.md

```md

```

# packages/ui/src/button.tsx

```tsx
import * as React from "react";

export interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  children: React.ReactNode;
}

export function Button({ children, className, ...props }: ButtonProps) {
  return (
    <button
      className={`px-4 py-2 rounded-md bg-blue-500 text-white hover:bg-blue-600 ${className}`}
      {...props}
    >
      {children}
    </button>
  );
}

```

# packages/ui/src/components/Avatar.tsx

```tsx

```

# packages/ui/src/components/Badge.tsx

```tsx

```

# packages/ui/src/components/Button.tsx

```tsx

```

# packages/ui/src/components/Card.tsx

```tsx

```

# packages/ui/src/components/Input.tsx

```tsx

```

# packages/ui/src/components/Toast.tsx

```tsx

```

# packages/ui/src/index.ts

```ts

```

# packages/ui/src/index.tsx

```tsx
// This is the entry point for your shared UI components.
// You can export components from here.
export { Button } from "./button";

```

# packages/ui/src/styles/index.css

```css

```

# packages/ui/tsconfig.json

```json
{
  "extends": "@repo/typescript-config/react-library.json",
  "compilerOptions": {
    "outDir": "dist",
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["src/**/*.ts", "src/**/*.tsx"],
  "exclude": ["node_modules"]
}

```

# QWEN.md

```md
# WBTH Project Context

This file provides context for AI assistants working on the WBTH project.

## Project Overview
- **Project Name**: WBTH (presumably a software project)
- **Type**: Monorepo (as evidenced by the apps/ directory and turbo.json)
- **Language**: TypeScript (based on tsconfig.json)
- **Package Manager**: Yarn (based on yarn.lock)
- **Build System**: Turbo (based on turbo.json)

## Key Configuration Files
- `package.json` - Root package configuration
- `tsconfig.json` - TypeScript configuration
- `turbo.json` - Build system configuration
- `.env.example` - Environment variable examples
- `wbth_6_week_build_plan_architecture_spec.md` - Architecture specification
- `wbth_monorepo_structure.md` - Monorepo structure documentation

## Project Structure
- `apps/` - Contains application packages (structure not fully visible)
- `.github/` - GitHub configuration
- `.idea/` - IDE configuration

## Development Guidelines
- Follow TypeScript best practices as defined in tsconfig.json
- Use ESLint for code linting (based on .eslintrc.cjs)
- Use Prettier for code formatting (based on .prettierrc)
- Respect the monorepo structure when making changes

## Context for AI Assistants
- When modifying code, consider the monorepo architecture
- Maintain consistency with existing code style and patterns
- Respect the environment variable system defined in .env files
- Consider how changes may affect multiple apps in the monorepo
```

# README.md

```md

```

# scripts/db.sh

```sh
#!/bin/bash

# ==============================================================================
# Database Management Script for WBTH
#
# Usage: ./scripts/db.sh [start|stop|status]
#
# Commands:
#   start   - Creates and starts the PostgreSQL Docker container if it doesn't
#             exist, or starts it if it is stopped.
#   stop    - Stops the PostgreSQL Docker container.
#   status  - Checks the status of the container.
# ==============================================================================

# --- Configuration ---
# These variables should match your .env file and Prisma connection string.
CONTAINER_NAME="wbth-db"
DB_USER="user"
DB_PASSWORD="password"
DB_NAME="wbth"
DB_PORT="5432"

# --- Helper Functions ---
# Function to print colored output
print_info() {
    echo -e "\033[34m[INFO]\033[0m $1"
}

print_success() {
    echo -e "\033[32m[SUCCESS]\033[0m $1"
}

print_error() {
    echo -e "\033[31m[ERROR]\033[0m $1"
}

# --- Command Functions ---
start_db() {
    # Check if Docker is running
    if ! docker info >/dev/null 2>&1; then
        print_error "Docker does not seem to be running. Please start Docker and try again."
        exit 1
    fi

    # Check if the container exists
    if [ "$(docker ps -a -q -f name=^/${CONTAINER_NAME}$)" ]; then
        # Container exists, check if it's running
        if [ "$(docker ps -q -f name=^/${CONTAINER_NAME}$)" ]; then
            print_info "Database container '${CONTAINER_NAME}' is already running."
        else
            # Container is stopped, so start it
            print_info "Starting existing database container '${CONTAINER_NAME}'..."
            docker start "${CONTAINER_NAME}"
            print_success "Container started."
        fi
    else
        # Container does not exist, so create it
        print_info "Creating and starting new database container '${CONTAINER_NAME}'..."
        docker run \
            --name "${CONTAINER_NAME}" \
            -e POSTGRES_USER="${DB_USER}" \
            -e POSTGRES_PASSWORD="${DB_PASSWORD}" \
            -e POSTGRES_DB="${DB_NAME}" \
            -p "${DB_PORT}:5432" \
            -d postgres

        print_success "Database container created and started."
        print_info "Waiting for PostgreSQL to be ready..."
        sleep 5 # Give the DB a moment to initialize
    fi
}

stop_db() {
    if [ "$(docker ps -q -f name=^/${CONTAINER_NAME}$)" ]; then
        print_info "Stopping database container '${CONTAINER_NAME}'..."
        docker stop "${CONTAINER_NAME}"
        print_success "Container stopped."
    else
        print_info "Database container '${CONTAINER_NAME}' is not running."
    fi
}

status_db() {
    if [ "$(docker ps -q -f name=^/${CONTAINER_NAME}$)" ]; then
        print_success "Database container '${CONTAINER_NAME}' is running."
        docker ps -f name=^/${CONTAINER_NAME}$
    else
        print_error "Database container '${CONTAINER_NAME}' is not running."
    fi
}

# --- Main Logic ---
COMMAND=$1

if [ -z "$COMMAND" ]; then
    echo "Usage: $0 [start|stop|status]"
    exit 1
fi

case "$COMMAND" in
    start)
        start_db
        ;;
    stop)
        stop_db
        ;;
    status)
        status_db
        ;;
    *)
        print_error "Invalid command: '$COMMAND'"
        echo "Usage: $0 [start|stop|status]"
        exit 1
        ;;
esac

```

# scripts/dev.sh

```sh
#!/usr/bin/env bash
set -euo pipefail
yarn -C packages/prisma prisma generate
yarn -C apps/web dev &
python apps/ml/wbth_ml/api.py

```

# scripts/lint.sh

```sh

```

# scripts/migrate.sh

```sh
#!/usr/bin/env bash
set -euo pipefail
yarn -C packages/prisma prisma migrate deploy

```

# scripts/seed.sh

```sh
#!/usr/bin/env bash
set -euo pipefail
yarn -C packages/prisma prisma db seed

```

# scripts/typecheck.sh

```sh

```

# tsconfig.json

```json
{
  "extends": "@repo/typescript-config/base.json",
  "compilerOptions": {
    "baseUrl": ".",
    "paths": {
      "@repo/ui/*": ["packages/ui/src/*"],
      "@repo/lib/*": ["packages/lib/src/*"],
      "@repo/prisma/*": ["packages/prisma/src/*"]
    }
  },
  "include": [
    "**/*.ts",
    "**/*.tsx",
    "**/*.js",
    "**/*.jsx",
    "next-env.d.ts",
    ".next/types/**/*.ts"
  ],
  "exclude": ["node_modules", "dist"]
}

```

# turbo.json

```json
{
  "$schema": "https://turbo.build/schema.json",
  "pipeline": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": ["dist/**", ".next/**", "!.next/cache/**"]
    },
    "dev": {
      "cache": false,
      "persistent": true
    },
    "lint": {},
    "test": {},
    "typecheck": {},
    "migrate": {
      "dependsOn": ["@repo/prisma#build"],
      "cache": false
    },
    "seed": {
      "dependsOn": ["@repo/prisma#build", "migrate"],
      "cache": false
    }
  }
}

```

# wbth_6_week_build_plan_architecture_spec.md

```md
# Web‑Based Tourism Hub (WBTH)

## Delivery Plan (1.5 Months / 6 Weeks)

**Methodology:** Agile with weekly sprints, demo each Friday, code freeze in Week 6 mid‑week.

### Week 1 — Foundations & Environments
- Repo setup (frontend, backend, ML service) with shared conventions.
- CI/CD (GitHub Actions): lint, test, build, deploy to staging.
- Provision cloud resources: Vercel (Next.js), Google Cloud Run (Flask ML & Node API), Neon/Postgres.
- App scaffolding: Next.js (app router), Auth (NextAuth, JWT), Prisma schema bootstrap.
- Design system: Tailwind base tokens, UI shells for key pages.
- Definition of Done (DoD) & tracking board.

**Deliverables:** running staging URLs; DB migrations v1; auth skeleton; basic UI frame.

### Week 2 — Core Domain Models & User/Auth Flows
- Implement entities: User, Guide, AccommodationProvider, Accommodation, Booking, Event, Rating, Payment (model), Notification.
- Role‑based access control & email verification.
- Profile create/edit for Tourist/Guide/Provider.
- Seed scripts & fixtures.

**Deliverables:** CRUD + RBAC for core entities; verified email login; seeded demo data.

### Week 3 — Booking & Availability
- Accommodation search filters (budget, location, amenities); map view.
- Guide discovery filters (language, expertise, location); availability calendar.
- Booking creation/cancel flows; status transitions; email notifications.
- Payment **model** integration (recording only) and receipts; admin dashboards (basic).

**Deliverables:** end‑to‑end booking for accommodation & guides (without card capture); transactional emails.

### Week 4 — ML Recommenders & Guide Matching
- Flask ML service endpoints:
  - `POST /recommendations/accommodations`
  - `POST /match/guides`
- Collaborative + content‑based hybrid using seeded interactions.
- Relevance scoring & A/B toggle; feedback collection (likes, skips, ratings).

**Deliverables:** personalized cards with match %; telemetry on clicks; ML unit tests.

### Week 5 — Events, Chatbot, Performance & QA
- Event discovery & admin curation; location‑based suggestions.
- Botpress chatbot embed and handoff links to pages.
- Perf passes: API 95p <1s, page LCP target <3s on staging.
- Accessibility checks; responsive polish; error states; empty states.

**Deliverables:** events module; chatbot online; perf and a11y report; beta sign‑off.

### Week 6 — Harden, Document, Launch
- Security review (authz matrix, rate‑limits, input validation, audit logging).
- Observability: logs, metrics, alerts; synthetic checks; backups.
- Final UAT; fix & doc sprint.
- Production cutover; monitoring dashboard & runbook.

**Deliverables:** production release; release notes; admin and user guides.

---

## High‑Level Architecture

- **Frontend (Next.js 13+ / TypeScript / Tailwind)** on **Vercel**.
- **Backend API: Next.js API routes (v1)** on **Vercel**; **Future:** dedicated **Node.js/Express** service on **Google Cloud Run** with matching REST contracts.
- **ML Service (Python/Flask, scikit‑learn)** on **Google Cloud Run**.
- **Database: PostgreSQL (Neon) via Prisma ORM**.
- **Email/Notifications:** SMTP (Gmail/Brevo) via server actions.
- **Maps/Location:** Leaflet + provider tiles; geocoding provider (swappable).

**Why Postgres?** Aligns with the interim report’s choice and Prisma support; SRS permits Prisma; see Compatibility notes below.

### ASCII Diagram
\`\`\`
[ Browser ]
    |  HTTPS
    v
[ Next.js (Vercel) ] -- REST --> [ Node.js API (Cloud Run) ] -- Prisma --> [ Postgres (Neon) ]
        |                               |
        | gRPC/REST                    | REST
        v                               v
[ Flask ML (Cloud Run) ]           [ SMTP / Email ]
        |
        v
   [ Model Store ]
\`\`\`

---

## Modules & Responsibilities

### 1) Identity & Access
- NextAuth (email/password), JWT (24h expiry + refresh), email verification.
- Roles: `tourist`, `guide`, `accommodation_provider`, `admin`.
- Middleware guards per route; audit log for auth events.

### 2) Catalogue & Profiles
- **Accommodation Provider**: property listings, amenities, pricing, photos, availability.
- **Guide**: certifications, languages[], expertise[], price, geo areas, calendar.
- **Tourist**: preferences (budget, interests, sustainability flags), history.

### 3) Booking
- Create/Cancel flows for accommodation or guide (one type per booking).
- States: `pending` → `confirmed` → `cancelled`.
- Notifications to all parties; receipt generation.
- **Payments (Model)**: record intent & outcome; no card capture in v1.

### 4) Recommendations (ML)

**Services & Endpoints**
- Flask service on Cloud Run
  - `POST /recommendations/accommodations` → ranked list of accommodations `{id, score, reasons[], filters_applied[]}`
  - `POST /match/guides` → ranked list of guides `{id, score, reasons[], filters_applied[]}`

**Shared Inputs**
- **Data (from PostgreSQL):** pulled via read‑only service account.
- **User preferences (from UI):** posted in request body.
- **Telemetry:** clicks, likes/skips, bookings feed back as implicit signals.

---

#### 4.1 Accommodation Recommendation — Simple Hybrid (Rule‑first + Scored Ranking)

**Data columns (per your spec):** `id, name, price_range, province, interests[], group_size, travel_style, num_booking_dates, location (city + lat/lng or district), amenities[], rating, prior_bookings`.

**Hard Rule Filters (fast pre‑filter in DB):**
1) **Availability**: candidate has open dates overlapping desired range.
2) **Budget window**: requested budget intersects `price_range` (min/max).
3) **Required amenities**: set inclusion (e.g., must have `wifi` and `hot_water`).
4) **Location (optional hard filter)**: if the user explicitly selects *“city only”*, filter to that city; otherwise keep broader set and let scoring handle tiers.
5) **Group size fit**: `group_size` ≥ requested party size.

**Scoring (on remaining candidates):** Weighted sum in [0, 1].
- `S_interests` — overlap of interests (Jaccard on tag set).
- `S_style` — 1 if travel_style matches; else 0.
- `S_price` — price alignment: 1 if in range; else distance‑penalized.
- `S_amenities` — Jaccard similarity of amenities.
- `S_location` — **tiered location score** based on requested location:
  - if **within selected city** → `1.00`
  - else if **within selected province** → `0.60`
  - else (**outside province**) → `0.15`
  - if no location preference provided → `0.50`
- `S_group` — 1 if capacity fits; else 0.
- `S_rating` — min(1, rating/5) normalized.
- `S_popularity` — from **prior_bookings** (log‑scaled): `log(1+n) / log(1+n_max)`.

**Total score**
\`\`\`
Score = w1*S_interests + w2*S_style + w3*S_price + w4*S_amenities +
        w5*S_location + w6*S_group + w7*S_rating + w8*S_popularity
\`\`\`
- Start weights: `w = [0.2, 0.05, 0.10, 0.15, 0.15, 0.10, 0.20, 0.05]`  
  (↑ gave a little more weight to location tiers; popularity reduced slightly.)
- Tie‑breakers: higher `rating`, then higher `prior_bookings`, then closer distance.

**Returned reasons** (for transparency): top 3 facets (e.g., _“within selected city; matches coastal & adventure; has pool & wifi”_).

**Rule‑Based Filtering (post‑score pruning):**
- Safety/content rules (e.g., adult‑only flags if user has minors), blackout rules, provider status.

**Data/Infra Notes:**
- Keep denormalized, query‑friendly columns (arrays) in Postgres; add GIN indexes for `interests[]` and `amenities[]`.  
- Store `province` as an enum/text with btree index; maintain city→province lookup.
- Optionally cache candidate IDs per (province, budget, amenities) bucket in Redis.

---

#### 4.2 Guide Matching — Simple, Transparent Ranker

**Data columns:** `id, name, duration, location (city), province, languages[], specializations[], gender, prior_bookings, rating`.

**Hard Rule Filters:**
1) **Duration**: guide supports the requested duration (exact or within ± bucket: half‑day, 1 day, 2–3 days, 4+).
2) **Language**: must include at least one requested language; prefer all.
3) **Location (optional hard filter)**: if the user selects *“city only”*, filter to that city; otherwise keep broader set and use tiered scoring below.
4) **Gender preference**: respected if provided.

**Scoring (point‑additive, then normalized to [0,1]):**
- **Location tier**: +3 if within **selected city**; +2 if within **selected province**; +0 if outside.
- **Languages**: +3 per exact match (cap at requested count).
- **Specializations**: +3 for any overlap; +1 per extra overlap up to +5 total.
- **Duration fit**: +2 if exact bucket; +1 if adjacent bucket.
- **Gender**: +1 if matches preference.
- **Popularity** (prior_bookings): +1 if above median; +2 if top quartile.
- **Rating**: up to +3 scaled from rating (e.g., `rating/5 * 3`).

**Normalization**: divide by max attainable points for the given request to produce a 0‑1 score.

**Returned reasons:** e.g., _“City match; English & Sinhala; Wildlife & Photography; 1‑day fit; high rating.”_

**Why simple?** Deterministic, explainable, minimal data. Later, swap in logistic regression/GBDT once we have labeled outcomes.

---

#### 4.3 Evaluation & Feedback Loop & Feedback Loop
- **Offline:** curated queries → expected top‑k; measure Precision@k, MAP.
- **Online:** CTR, booking conversion, dwell time; A/B flag for weight sets.
- **Quality checks:** filter correctness, reason strings, cold‑start handling.

---

#### 4.4 Implementation Plan (Tasks)

**High‑Level Epics**
1) **Data & Indexing** — schemas, seeders, read models, indexes.
2) **Filtering Engine** — fast SQL filters + validation.
3) **Scoring Engine** — Python score calculators (accom & guide).
4) **API & Contracts** — request/response DTOs, error semantics, reasons[].
5) **Caching & Perf** — candidate caching, warm instances, timeouts.
6) **Telemetry & A/B** — events, dashboards, config for weights.
7) **QA & Launch** — test packs, guardrails, docs.

**Low‑Level Tasks (selected)**
- **Data & Indexing**
  - Add arrays: `interests[]`, `amenities[]`, `languages[]`, `specializations[]`.
  - Spatial support: store `lat, lng` (or districts) + Haversine helper.
  - Indexes: GIN on array cols; btree on `price_min/price_max`, `rating`, `region`.
  - Materialized view: availability windows per accommodation.
- **Filtering Engine**
  - SQL builders for: availability overlap, budget, geo, required amenities, group size.
  - Validation of user input (enums, ranges) + error codes.
- **Scoring Engine (Accommodation)**
  - Similarity functions (Jaccard, distance penalty, price alignment).
  - Compose weighted score; expose top‑k with `reasons[]`.
- **Scoring Engine (Guide)**
  - Point‑additive scoring and normalization.
- **API & Contracts**
  - DTOs: `/recommendations/accommodations` & `/match/guides`.
  - Include `filters_applied[]`, `reasons[]`, and `debug` flag (admin only).
- **Caching & Perf**
  - LRU cache of candidates per (geo,budget,amenities) key.
  - Response cache for identical queries (short TTL).
  - Cloud Run min instance = 1 (warm starts); 2s upstream timeout; 3 retries.
- **Telemetry & A/B**
  - Events: impression, click, like/skip, booking (IDs only).
  - Config store for weights; experiment toggles.
- **QA & Launch**
  - Synthetic query suite; P@5 thresholds; guardrail tests for filters.
  - Red‑team cases (empty results, conflicting prefs, extreme distances).

**Deliverables**
- Working endpoints returning ranked lists with clear reasons.
- Docs: algorithm overview, weight config, examples, and test plan.

---

### 5) Events
- Admin‑curated events; categories; geolocation; date range queries.
- Surfacing near travel dates and user interests.

### 6) Chatbot
- Botpress webchat widget; deep links to app pages; escalation guidance.

### 7) Admin
- User moderation; verification workflows; payments list; content management; metrics.

---

## API Surface (selected)

**Auth**
- `POST /auth/register` — role‑aware registration + email verify trigger.
- `POST /auth/login` — JWT session.
- `POST /auth/verify` — complete email verification.

**Profiles**
- `GET/PUT /me` — current user profile.
- `GET /guides?lang=&expertise=&geo=&available=`
- `GET /accommodations?budget=&geo=&amenities=`

**Bookings**
- `POST /bookings` — create (type: `accommodation|guide`).
- `PATCH /bookings/:id/cancel`
- `GET /bookings/mine`

**Payments (model)**
- `POST /payments` — record; attach to booking.

**Events**
- `GET /events?category=&from=&to=&near=`
- `POST /events` (admin)

**ML**
- `POST /ml/recommendations/accommodations`
- `POST /ml/match/guides`

---

## Data Model (Prisma/Postgres)

- **User**(id UUID, name, email unique, password_hash, contact_no, role, created_at)
- **Guide**(user_id FK, experience[], languages[], expertise[], rating, account_no, price)
- **AccommodationProvider**(user_id FK, provider_id UUID, company_name)
- **Accommodation**(provider_id FK, name, type[], amenities[], rating, account_no, budget[], location)
- **Booking**(id UUID, user_id FK, type, start_date, end_date, location, price, status, description[])
- **Rating**(id UUID, provider_id FK, rating)
- **Event**(id UUID, category, date, location, description[])
- **Payment**(id UUID, receiver_id, sender_id, booking_id, amount, status)
- **Notification**(id UUID, type, message[], created_at)
- **Admin**(id UUID, email, password_hash)

> Notes: Use generated ULIDs/UUIDs; timestamps with time zone (timestamptz); partial indexes for frequently filtered fields; text[] to mirror current docs; consider EAV or JSONB later for flexible attributes.

---

## Non‑Functional Requirements (NFRs)
- **Performance:** API p95 < 1000 ms; ML recommendations < 5 s (cold) / < 1 s (warm).
- **Scalability:** stateless services on Cloud Run with min instances for ML warm‑start.
- **Security:** JWT rotation, rate limits, input validation, output encoding, TLS, secrets in GCP/Vercel.
- **Privacy:** store minimal PII; encrypt at rest & in transit; delete/anonymize on request.
- **Observability:** structured logs, metrics (latency, error rates), tracing between Next/API/ML.

---

## CI/CD & Environments
- **Branches:** `main` (prod), `develop` (staging), PR branches.
- **Pipelines:** lint → unit tests (TS/Py) → build → integration tests → deploy to staging → UAT gate → prod.
- **Database:** Prisma migrations; shadow DB for CI; daily backups; point‑in‑time recovery.

---

## Testing Strategy
- **Unit:** Vitest (API), RTL/Playwright (UI), Pytest (ML).
- **Integration:** Postman collections in CI; DB integration; contract tests for ML.
- **Performance:** k6/Locust; DB query plans reviewed.
- **UAT:** scripts per persona; accessibility checks (axe‑core); mobile sanity.

---

## Risk Register & Mitigations (excerpt)
- **Cold ML latency** → keep 1 warm instance; cache top‑N per segment.
- **Data quality sparse** → bootstrap with curated data; collect implicit feedback.
- **Auth complexity** → reuse NextAuth flows; small, audited surface.
- **Map provider limits** → abstract map adapters; configurable tiles.

---

## Definition of Done (per feature)
- Story & acceptance criteria met; unit + integration tests pass; accessibility reviewed; telemetry added; docs updated; demo recorded.

---

## Compatibility Notes (SRS vs Interim)
- **DB:** Interim favors **PostgreSQL + Prisma**. We will **standardize on PostgreSQL for deployment** (Prisma supports both PostgreSQL and MySQL) while keeping schemas portable should a future switch be required.
- **Backend:** Interim allows **Next.js API routes now** with a **future dedicated backend**. We will follow **Interim** for v1 by implementing all APIs in **Next API routes on Vercel**. Later, we can introduce a dedicated **Node.js/Express** service on Cloud Run with identical REST contracts to maintain compatibility.
- **Tooling:** Yarn workspaces + Turborepo; TypeScript across Node/Next; Ruff/Black for Python; ESLint/Prettier; commitlint + conventional commits. _Initialize Yarn via npm:_ `npm install yarn` then use `yarn`.

---

## Acceptance Criteria for Final Submission
- Deployed production URLs (frontend, API, ML) and credentials for test users of all roles.
- Create/cancel bookings end‑to‑end with emails.
- Personalized accommodation and guide results surfaced with visible match scores.
- Events browsing with filters and details pages.
- Admin dashboards to verify users and moderate content.
- Release notes + user/admin guides + architecture README.


---

## Monorepo Architecture & Developer Experience (DX)

**Tooling:** pnpm workspaces + Turborepo; TypeScript across Node/Next; Ruff/Black for Python; ESLint/Prettier; commitlint + conventional commits.

**Repo Layout**
\`\`\`
wbth/
  apps/
    web/            # Next.js 13+ (app router + API routes for v1)
    api/            # (future) Node.js/Express service (migrate from Next API routes later)
    ml/             # Flask service (recommendations & matching)
  packages/
    ui/             # shared React UI components (Tailwind + shadcn)
    config/         # eslint, tsconfig, jest, prettier shared configs
    lib/            # shared TS utilities (schemas, DTOs, guards)
    prisma/         # Prisma schema, migrations, seeders
  infra/
    gcp/            # Cloud Run, Neon, etc. IaC (Terraform or Pulumi)
    vercel/         # project config & env templates
  docs/             # architecture, ADRs, API docs, runbooks
  .github/          # actions
  turbo.json
  pnpm-workspace.yaml
\`\`\`

**Workspaces (package.json)**
\`\`\`json
{
  "private": true,
  "workspaces": [
    "apps/*",
    "packages/*"
  ]
}
\`\`\`
packages:
  - "apps/*"
  - "packages/*"
\`\`\`

**Turborepo pipes (turbo.json)**
- `build`: web → api → ml (ml independent), packages as deps
- `lint`, `test`, `typecheck`, `dev`, `deploy`

**Scripts (root)**
- `dev`: `turbo run dev --parallel`
- `build`: `turbo run build`
- `test`: `turbo run test`
- `lint`: `turbo run lint`
- `migrate`: `yarn workspace packages/prisma prisma migrate deploy`
- `seed`: `yarn workspace packages/prisma prisma db seed`

**Env Management**
- `.env.example` at root; per‑app `.env` files; use Doppler/GCP Secrets for prod.

**IDE Setup**
- Recommend VS Code with Workspace settings: formatOnSave, eslint.validate, Python venv for `apps/ml`.
- Debug configs: `.vscode/launch.json` for web/api/ml; automatic port forwarding.

---

## Implementation Work Plan — High‑Level & Low‑Level Tasks by Module
*(Designed as IDE‑friendly, copy‑paste checklists and file paths.)*

### A) Identity & Access (NextAuth + JWT + RBAC)
**High‑Level Tasks**
1. Auth flows (register, verify email, login, logout, password reset).
2. RBAC (tourist, guide, provider, admin) with API/route guards.
3. Audit logging of auth events.

**Low‑Level Tasks**
- **apps/web**
  - `app/(auth)/register/page.tsx`: form w/ zod validation; POST `/api/auth/register`.
  - `app/(auth)/login/page.tsx`: NextAuth credentials provider UI.
  - `middleware.ts`: protect routes by role.
  - `lib/auth.ts`: NextAuth config; JWT callbacks to embed role & userId.
- **apps/api**
  - `src/routes/auth.ts`: `POST /auth/register|login|verify`.
  - `src/middleware/requireRole.ts`: guard; map roles → routes.
  - `src/logging/audit.ts`: `audit("auth", {...})` structured logs.
- **packages/prisma**
  - `schema.prisma`: `User`, `VerificationToken` models; unique email; role enum.
  - Seed: demo users for all roles.

### B) Catalogue & Profiles
**High‑Level Tasks**
1. Provider/Guide/Tourist profile CRUD.
2. Media upload (images) with signed URLs.
3. Search lists with filters & pagination.

**Low‑Level Tasks**
- **DB/Model**: `Guide`, `AccommodationProvider`, `Accommodation` with arrays & indexes; `Province`, `City` tables or enums.
- **API**: `GET/PUT /me`, `GET /guides`, `GET /accommodations` with query builders for price, province, city, amenities, languages, specialization.
- **Web**: filter panels (autocomplete for city/province), cards, pagination, skeleton loaders.
- **Media**: upload component → API route → cloud storage (GCS) signed PUT; store public URL.

### C) Booking Engine
**High‑Level Tasks**
1. Availability model (accommodation, guide).
2. Create/cancel bookings with status transitions.
3. Email notifications & receipts.

**Low‑Level Tasks**
- **DB**: `Availability` view/materialization; `Booking` with type enum; constraints: dates `start<=end`.
- **API**: `POST /bookings`, `PATCH /bookings/:id/cancel`, `GET /bookings/mine`.
- **Domain**: state machine (`pending→confirmed→cancelled`); invariants.
- **Web**: date pickers (range), conflict validation, success screens.
- **Emails**: templates in `packages/lib/email`; sender in `apps/api/src/services/email.ts`.

### D) Events Module
**High‑Level Tasks**
1. Admin CRUD for events; categories; geo/date filters.
2. Listing & detail pages with maps.

**Low‑Level Tasks**
- **DB**: `Event(id, title, category, start, end, city, province, location, description)`; GIN on category.
- **API**: `GET /events?category&from&to&near`, `POST /events` (admin).
- **Web**: `/events`, `/events/[id]`; map pin component; filters with URL state.

### E) Chatbot Integration (Botpress)
**High‑Level Tasks**
1. Embed widget; SSO handoff links.
2. Context links to pages.

**Low‑Level Tasks**
- Script loader in `apps/web/app/layout.tsx`.
- Handoff URLs including query params for prefilled searches.

### F) Admin Dashboard
**High‑Level Tasks**
1. User verification & moderation.
2. Content management (accommodations, guides, events).
3. Metrics overview.

**Low‑Level Tasks**
- **Web**: `/admin/*` routes; table components from `packages/ui`.
- **API**: admin guards; `GET /admin/stats`.
- **Charts**: basic charts with Recharts; server data hooks.

### G) Recommendations & Guide Matching (ML)
*(Detailed earlier; include only execution tasks here.)*
**High‑Level Tasks**
1. SQL candidate filters; DTOs; scoring functions; reasons[].
2. Flask endpoints; unit tests; A/B weights.
3. Integration in web (cards + reasons + like/skip events).

**Low‑Level Tasks**
- **apps/ml**: `accom.py`, `guide.py` for scorers; `api.py` (Flask routes); `tests/` with Pytest.
- **apps/api**: proxy routes `/ml/*` or service client w/ retries.
- **apps/web**: fetchers/hooks; UI for reasons & feedback buttons.

### H) Payments (Model Only)
**High‑Level Tasks**
1. Record payment intents/outcomes attached to bookings.
2. Receipt generation (PDF/HTML).

**Low‑Level Tasks**
- **DB**: `Payment(id, receiver_id, sender_id, booking_id, amount, status)`.
- **API**: `POST /payments` (record only).
- **Web**: receipt page; email template.

### I) Notifications & Email
**High‑Level Tasks**
1. Transactional emails and in‑app toasts.
2. Template library & preview.

**Low‑Level Tasks**
- **packages/lib/email**: MJML/React email templates; preview route `/dev/emails`.
- **API**: mailer service (SMTP/Brevo); queue option (later).

### J) Observability & Ops
**High‑Level Tasks**
1. Logging, metrics, traces; dashboards & alerts.
2. Backups & synthetic checks.

**Low‑Level Tasks**
- **Logging**: pino for Node; `structlog` for Python; request IDs propagated.
- **Metrics**: OpenTelemetry exporters; p95 latency SLOs.
- **Dashboards**: GCP + Vercel; uptime checks hitting health endpoints.
- **Backups**: Neon PITR; nightly verify script.

### K) Security & Compliance
**High‑Level Tasks**
1. Input validation; rate limiting; secret management.
2. AuthZ matrix review; least privilege service accounts.

**Low‑Level Tasks**
- Zod schemas for all DTOs; celebrate/Joi on Express.
- Helmet/CORS; `express-rate-limit`.
- Secrets via GCP Secret Manager; no secrets in repo.
- Periodic dependency audit (`pnpm audit`, `pip-audit`).

### L) CI/CD & Quality Gates
**High‑Level Tasks**
1. Build/lint/test pipelines; preview deploys; migrations.
2. UAT gates and release tagging.

**Low‑Level Tasks**
- **Actions**: `.github/workflows/ci.yml` with matrix: web/api/ml.
- **Preview**: Vercel preview for web; Cloud Run staging for api/ml.
- **Migrations**: job step `yarn workspace packages/prisma prisma migrate deploy`.
- **Artifacts**: Playwright reports, coverage; release notes generator (changesets).

### M) Testing Strategy (Executable)
**High‑Level Tasks**
1. Unit, integration, e2e (web), contract tests (API↔ML).

**Low‑Level Tasks**
- **Unit**: Vitest (web/api), Pytest (ml).
- **Integration**: Supertest (api); db test container; Postman collection in CI.
- **E2E**: Playwright flows (auth, search, booking, cancel).
- **Contract**: OpenAPI schemas; `schemathesis` fuzzing.

### N) Data & Migrations
**High‑Level Tasks**
1. Prisma schema evolution; seed data for demo.

**Low‑Level Tasks**
- `packages/prisma/schema.prisma` with enums (province, amenities, languages, specializations).
- Seeders for demo accommodations/guides/events with provinces/cities and prior_bookings.
- Migration scripts; `shadowDatabaseUrl` for CI.

---

## Sprint‑Friendly Backlog (6 Weeks)
- **W1**: Monorepo, auth skeleton, DB init, CI, staging envs.
- **W2**: Profiles & catalogue; search; media upload.
- **W3**: Booking engine; emails; admin basics.
- **W4**: ML endpoints & integration; reasons[] UI; telemetry.
- **W5**: Events; chatbot; performance; polish.
- **W6**: Security/observability; docs; UAT; production cutover.


```

# wbth_monorepo_structure.md

```md
# WBTH Monorepo — Complete 6‑Week Implementation Folder Structure

This document lists a **production-ready monorepo layout** with **all files you’ll need** to implement the project in 6 weeks (Next.js + Prisma/Postgres + Flask ML). It includes a tree, file purposes, and minimal starter contents for key config files so the repo is immediately scaffoldable.

---

## Repository Tree

\`\`\`text
wbth/
  .editorconfig
  .gitignore
  .nvmrc
  .prettierignore
  .prettierrc
  .eslintrc.cjs
  LICENSE
  README.md
  package.json
  pnpm-lock.yaml
  pnpm-workspace.yaml
  turbo.json
  .env.example
  .envrc.example
  scripts/
    dev.sh
    migrate.sh
    seed.sh
    lint.sh
    typecheck.sh
  .github/
    ISSUE_TEMPLATE/
      bug_report.md
      feature_request.md
    PULL_REQUEST_TEMPLATE.md
    workflows/
      ci.yml
      release.yml
  docs/
    README.md
    adr/
      0001-monorepo-structure.md
      0002-db-choice-prisma-postgres.md
      0003-auth-and-rbac.md
    api/
      openapi.yaml
      contracts.md
    runbooks/
      deploy-web-vercel.md
      deploy-ml-cloud-run.md
      rollback.md
      seeding.md
    wireframes/
      dashboard.png
      booking-flow.png
  infra/
    vercel/
      vercel.json
      env.example
    db/
      README.md
      docker-compose.postgres.yml
      backup.sh
      restore.sh
    gcp/
      cloudrun-service-ml.yaml
      service-account-ml.json.example
      README.md
  packages/
    prisma/
      package.json
      schema.prisma
      migrations/
        (auto-generated on first migrate)
      seed/
        index.ts
        users.ts
        guides.ts
        accommodations.ts
        events.ts
      src/
        client.ts
        types.ts
      tsconfig.json
      README.md
    ui/
      package.json
      src/
        index.ts
        components/
          Button.tsx
          Card.tsx
          Input.tsx
          Avatar.tsx
          Badge.tsx
          Toast.tsx
        styles/
          index.css
      tsconfig.json
      README.md
    lib/
      package.json
      src/
        auth/
          rbac.ts
          tokens.ts
        dto/
          index.ts
          user.ts
          guide.ts
          accommodation.ts
          booking.ts
          event.ts
          rating.ts
          payment.ts
          notification.ts
        validation/
          index.ts
          user.zod.ts
          booking.zod.ts
        utils/
          logger.ts
          fetcher.ts
          pagination.ts
          errors.ts
      tsconfig.json
      README.md
  apps/
    web/
      .env.example
      next.config.js
      postcss.config.js
      tailwind.config.ts
      tsconfig.json
      package.json
      middleware.ts
      public/
        favicon.ico
        logo.svg
        og.png
      app/
        layout.tsx
        globals.css
        page.tsx
        (auth)/
          layout.tsx
          login/page.tsx
          register/page.tsx
          verify/page.tsx
          reset-password/page.tsx
        (dashboard)/
          layout.tsx
          page.tsx
          tourist/page.tsx
          guide/page.tsx
          provider/page.tsx
          admin/page.tsx
        accommodations/
          page.tsx
          [id]/page.tsx
        guides/
          page.tsx
          [id]/page.tsx
        events/
          page.tsx
          [id]/page.tsx
        bookings/
          page.tsx
          new/page.tsx
          [id]/page.tsx
        api/
          auth/
            route.ts
            callback/route.ts
            register/route.ts
            reset/route.ts
          profiles/
            route.ts
          accommodations/
            route.ts
            [id]/route.ts
          guides/
            route.ts
            [id]/route.ts
          events/
            route.ts
            [id]/route.ts
          bookings/
            route.ts
            [id]/route.ts
          payments/
            route.ts
          ratings/
            route.ts
          notifications/
            route.ts
          ml/
            recommend/route.ts
            match-guide/route.ts
      components/
        Header.tsx
        Footer.tsx
        Nav.tsx
        AuthGuard.tsx
        DataTable.tsx
        EmptyState.tsx
        Loading.tsx
      lib/
        auth.ts
        prisma.ts
        email.ts
        api.ts
        rbac.ts
        constants.ts
        hooks/
          useDebounce.ts
          useToast.ts
      styles/
        prose.css
      tests/
        e2e/
          auth.spec.ts
          booking.spec.ts
        unit/
          api-auth.test.ts
          booking-utils.test.ts
        vitest.config.ts
      lint-staged.config.mjs
      playwright.config.ts
    ml/
      .env.example
      Dockerfile
      gunicorn.conf.py
      requirements.txt
      README.md
      wbth_ml/
        __init__.py
        api.py
        accom.py
        guide.py
        utils.py
        models/
          __init__.py
          accom_recommender.pkl (placeholder)
          guide_matcher.pkl (placeholder)
        tests/
          __init__.py
          test_api.py
          test_accom.py
          test_guide.py
\`\`\`

---

## Key Files — Purpose & Minimal Starter Contents

> You can paste these directly to bootstrap the repo.

### Root configuration

**`package.json`**
\`\`\`json
{
  "name": "wbth",
  "private": true,
  "packageManager": "pnpm@9.0.0",
  "scripts": {
    "dev": "turbo run dev --parallel",
    "build": "turbo run build",
    "lint": "turbo run lint",
    "test": "turbo run test",
    "typecheck": "turbo run typecheck",
    "migrate": "pnpm -C packages/prisma prisma migrate deploy",
    "seed": "pnpm -C packages/prisma prisma db seed"
  },
  "devDependencies": {
    "turbo": "^2.0.0",
    "prettier": "^3.3.3"
  },
  "workspaces": [
    "apps/*",
    "packages/*"
  ]
}
\`\`\`

**`.gitignore`**
\`\`\`
node_modules
.env*
*.local
dist
.next
coverage
.mypy_cache
__pycache__/
*.pyc
.DS_Store
\`\`\`
**`.editorconfig`**
\`\`\`
root = true

[*]
indent_style = space
indent_size = 2
charset = utf-8
end_of_line = lf
insert_final_newline = true
trim_trailing_whitespace = true
\`\`\`

**`pnpm-workspace.yaml`**
\`\`\`yaml
packages:
  - "apps/*"
  - "packages/*"
\`\`\`

**`turbo.json`**
\`\`\`json
{
  "$schema": "https://turbo.build/schema.json",
  "pipeline": {
    "build": { "dependsOn": ["^build"], "outputs": ["dist/**", ".next/**"] },
    "dev": { "cache": false },
    "lint": {},
    "test": {},
    "typecheck": {}
  }
}
\`\`\`

**`.env.example`**
\`\`\`
# Shared
DATABASE_URL=postgresql://user:pass@host:5432/wbth
JWT_SECRET=replace-me

# Web
NEXTAUTH_URL=http://localhost:3000
NEXTAUTH_SECRET=replace-me
ML_SERVICE_URL=http://localhost:8080

# ML
PORT=8080
\`\`\`

---

### `packages/prisma`

**`schema.prisma` (minimal skeleton — expand models as needed)**
\`\`\`prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  role      Role     @default(TOURIST)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  bookings  Booking[]
  ratings   Rating[]
}

model Guide {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String   @unique
  bio       String?
  skills    String[]
  ratings   Rating[]
}

model Accommodation {
  id          String   @id @default(cuid())
  name        String
  providerId  String
  location    String
  pricePerNight Int
  ratings     Rating[]
  bookings    Booking[]
}

model Event {
  id          String   @id @default(cuid())
  title       String
  description String?
  startsAt    DateTime
  endsAt      DateTime
}

model Booking {
  id              String   @id @default(cuid())
  user            User     @relation(fields: [userId], references: [id])
  userId          String
  kind            BookingKind
  accommodation   Accommodation? @relation(fields: [accommodationId], references: [id])
  accommodationId String?
  guide           Guide?   @relation(fields: [guideId], references: [id])
  guideId         String?
  createdAt       DateTime @default(now())
  status          BookingStatus @default(PENDING)
}

model Rating {
  id        String   @id @default(cuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  stars     Int
  comment   String?
  guide     Guide?        @relation(fields: [guideId], references: [id])
  guideId   String?
  accommodation Accommodation? @relation(fields: [accommodationId], references: [id])
  accommodationId String?
  createdAt DateTime @default(now())
}

model Payment {
  id        String   @id @default(cuid())
  booking   Booking  @relation(fields: [bookingId], references: [id])
  bookingId String
  amount    Int
  status    PaymentStatus @default(RECORDED)
  createdAt DateTime @default(now())
}

enum Role { ADMIN PROVIDER GUIDE TOURIST }
enum BookingKind { ACCOMMODATION GUIDE }
enum BookingStatus { PENDING CONFIRMED CANCELLED }
enum PaymentStatus { RECORDED FAILED REFUNDED }
\`\`\`

**`src/client.ts`**
\`\`\`ts
import { PrismaClient } from '@prisma/client';
export const prisma = new PrismaClient();
\`\`\`

**`seed/index.ts`**
\`\`\`ts
import { prisma } from '../src/client';
import users from './users';
import guides from './guides';
import accommodations from './accommodations';
import events from './events';

async function main() {
  await prisma.user.createMany({ data: users });
  // …create related guides, accommodations, events
}
main().catch((e) => { console.error(e); process.exit(1); }).finally(async () => prisma.$disconnect());
\`\`\`

---

### `apps/web` (Next.js 13+ App Router)

**`package.json`**
\`\`\`json
{
  "name": "@wbth/web",
  "private": true,
  "scripts": {
    "dev": "next dev -p 3000",
    "build": "next build",
    "start": "next start -p 3000",
    "lint": "eslint .",
    "test": "vitest run",
    "typecheck": "tsc --noEmit"
  },
  "dependencies": {
    "@prisma/client": "^5.18.0",
    "next": "14.2.5",
    "next-auth": "^5.0.0",
    "react": "18.3.1",
    "react-dom": "18.3.1",
    "zod": "^3.23.8"
  },
  "devDependencies": {
    "eslint": "^9.11.0",
    "typescript": "^5.5.4",
    "vitest": "^2.0.0",
    "@types/node": "^20.11.30",
    "@types/react": "^18.2.66",
    "tailwindcss": "^3.4.9",
    "postcss": "^8.4.44",
    "autoprefixer": "^10.4.20"
  }
}
\`\`\`

**`next.config.js`**
\`\`\`js
/** @type {import('next').NextConfig} */
const nextConfig = {
  experimental: { serverActions: true },
  images: { remotePatterns: [{ protocol: 'https', hostname: '**' }] },
  redirects: async () => [
    { source: '/dashboard', destination: '/(dashboard)', permanent: false }
  ]
};
module.exports = nextConfig;
\`\`\`

**`middleware.ts`**
\`\`\`ts
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';

export function middleware(req: NextRequest) {
  const path = req.nextUrl.pathname;
  // very light RBAC gate (expand later)
  if (path.startsWith('/(dashboard)') && !req.cookies.get('session')) {
    return NextResponse.redirect(new URL('/(auth)/login', req.url));
  }
  return NextResponse.next();
}
\`\`\`

**`app/api/ml/recommend/route.ts`**
\`\`\`ts
import { NextRequest, NextResponse } from 'next/server';

export async function POST(req: NextRequest) {
  const body = await req.json();
  const mlUrl = process.env.ML_SERVICE_URL ?? 'http://localhost:8080';
  const res = await fetch(`${mlUrl}/recommend`, {
    method: 'POST', headers: { 'content-type': 'application/json' }, body: JSON.stringify(body)
  });
  const data = await res.json();
  return NextResponse.json(data);
}
\`\`\`

*(Create similar handlers for `match-guide`, `bookings`, `accommodations`, `guides`, etc.)*

**`lib/prisma.ts`**
\`\`\`ts
import { PrismaClient } from '@prisma/client';
declare global {
  // eslint-disable-next-line no-var
  var prisma: PrismaClient | undefined;
}
export const prisma = global.prisma || new PrismaClient();
if (process.env.NODE_ENV !== 'production') global.prisma = prisma;
\`\`\`

**`tailwind.config.ts`**
\`\`\`ts
import type { Config } from 'tailwindcss';
const config: Config = {
  content: ['./app/**/*.{ts,tsx}', './components/**/*.{ts,tsx}', '../../packages/ui/src/**/*.{ts,tsx}'],
  theme: { extend: {} },
  plugins: [require('@tailwindcss/typography'), require('@tailwindcss/forms')]
};
export default config;
\`\`\`

---

### `apps/ml` (Flask + Gunicorn on Cloud Run)

**`requirements.txt`**
\`\`\`
flask
gunicorn
numpy
scikit-learn
pydantic
\`\`\`

**`Dockerfile`**
\`\`\`dockerfile
FROM python:3.11-slim
WORKDIR /app
ENV PYTHONDONTWRITEBYTECODE=1 PYTHONUNBUFFERED=1
COPY requirements.txt ./
RUN pip install --no-cache-dir -r requirements.txt
COPY wbth_ml ./wbth_ml
EXPOSE 8080
CMD ["gunicorn", "-c", "wbth_ml/../gunicorn.conf.py", "wbth_ml.api:app"]
\`\`\`

**`gunicorn.conf.py`**
\`\`\`py
bind = "0.0.0.0:8080"
workers = 2
threads = 4
timeout = 30
\`\`\`

**`wbth_ml/api.py`**
\`\`\`py
from flask import Flask, request, jsonify
from wbth_ml.accom import recommend_accommodations
from wbth_ml.guide import match_guide

app = Flask(__name__)

@app.post("/recommend")
def recommend():
    payload = request.get_json(force=True)
    return jsonify(recommend_accommodations(payload))

@app.post("/match-guide")
def match():
    payload = request.get_json(force=True)
    return jsonify(match_guide(payload))

@app.get("/healthz")
def health():
    return {"ok": True}
\`\`\`

**`wbth_ml/accom.py`**
\`\`\`py
def recommend_accommodations(payload: dict):
    # Stub logic — replace with model inference
    return {"items": [], "explain": "cold start recommendation stub"}
\`\`\`

**`wbth_ml/guide.py`**
\`\`\`py
def match_guide(payload: dict):
    # Stub logic — replace with model inference
    return {"guides": [], "explain": "skills/location matching stub"}
\`\`\`

---

### Infra

**`infra/vercel/vercel.json`**
\`\`\`json
{
  "buildCommand": "pnpm -C apps/web build",
  "outputDirectory": "apps/web/.next",
  "framework": "nextjs"
}
\`\`\`

**`infra/db/docker-compose.postgres.yml`**
\`\`\`yaml
version: "3.9"
services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_USER: postgres
      POSTGRES_DB: wbth
    ports: ["5432:5432"]
    volumes:
      - pgdata:/var/lib/postgresql/data
volumes:
  pgdata:
\`\`\`

---

## Development Scripts

**`scripts/dev.sh`**
\`\`\`bash
#!/usr/bin/env bash
set -euo pipefail
pnpm -C packages/prisma prisma generate
pnpm -C apps/web dev &
python apps/ml/wbth_ml/api.py
\`\`\`

**`scripts/migrate.sh`**
\`\`\`bash
#!/usr/bin/env bash
set -euo pipefail
pnpm -C packages/prisma prisma migrate deploy
\`\`\`

**`scripts/seed.sh`**
\`\`\`bash
#!/usr/bin/env bash
set -euo pipefail
pnpm -C packages/prisma prisma db seed
\`\`\`

---

## How to Use

1. **Install toolchain**
   \`\`\`bash
   corepack enable && corepack prepare pnpm@latest --activate
   pnpm i
   \`\`\`
2. **Start Postgres (optional local)**
   \`\`\`bash
   docker compose -f infra/db/docker-compose.postgres.yml up -d
   \`\`\`
3. **Env**
   - Copy `.env.example` to `.env` per app (`apps/web`, `apps/ml`) and set secrets.
4. **Generate & Migrate**
   \`\`\`bash
   pnpm -C packages/prisma prisma generate
   pnpm -C packages/prisma prisma migrate dev
   \`\`\`
5. **Run**
   \`\`\`bash
   pnpm dev
   \`\`\`

---

> Tip: keep Week 1 focused on scaffolding + auth + two core flows; Week 2 on catalogue + booking; Week 3 ML stubs; Weeks 4–5 polish/tests; Week 6 demo/QA.


```

